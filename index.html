<!DOCTYPE html>
<html lang="en" class="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Universal AI Chat â€” Liquid LFM Thinking</title>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- marked.js for Markdown -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- highlight.js for code blocks -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css" id="hljs-light-theme" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" id="hljs-dark-theme" disabled />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet" />

  <script>
    // Tailwind config BEFORE body renders
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['DM Sans', 'sans-serif'],
            mono: ['DM Mono', 'monospace'],
          },
          colors: {
            gemini: {
              blue: '#1a73e8',
              teal: '#0d9488',
              purple: '#8b5cf6',
              surface: '#f0f4f9',
              'surface-dark': '#1e2130',
              'sidebar': '#f8f9fa',
              'sidebar-dark': '#131722',
              'msg-user': '#e8f0fe',
              'msg-user-dark': '#1e3a5f',
            }
          }
        }
      }
    };
  </script>

  <style>
    /* â”€â”€â”€ Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    *, *::before, *::after { box-sizing: border-box; }

    html, body {
      margin: 0; padding: 0;
      font-family: 'DM Sans', sans-serif;
      height: 100%;
      overscroll-behavior: none;
    }

    /* Prevent FOUC */
    #loading {
      position: fixed; inset: 0;
      display: flex; align-items: center; justify-content: center;
      background: #fff; z-index: 9999;
      font-family: 'DM Sans', sans-serif;
      font-size: 1rem; color: #666;
      transition: opacity 0.3s ease;
    }
    #loading.hidden { opacity: 0; pointer-events: none; }

    .dark #loading { background: #131722; color: #aaa; }

    /* â”€â”€â”€ App Shell â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #app {
      display: flex;
      min-height: 100dvh;
      max-height: 100dvh;
      overflow: hidden;
      background: #fff;
    }
    .dark #app { background: #1e2130; }

    /* â”€â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #sidebar {
      width: 260px;
      min-width: 260px;
      display: flex;
      flex-direction: column;
      background: #f8f9fa;
      border-right: 1px solid #e5e7eb;
      transition: transform 0.25s cubic-bezier(0.4,0,0.2,1);
      z-index: 40;
      height: 100dvh;
      overflow: hidden;
    }
    .dark #sidebar {
      background: #131722;
      border-color: #2a2f45;
    }

    /* Mobile: sidebar slides in as overlay */
    @media (max-width: 767px) {
      #sidebar {
        position: fixed;
        top: 0; left: 0; bottom: 0;
        transform: translateX(-100%);
        box-shadow: 4px 0 24px rgba(0,0,0,0.15);
      }
      #sidebar.open { transform: translateX(0); }
      #sidebar-overlay {
        display: none;
        position: fixed; inset: 0;
        background: rgba(0,0,0,0.4);
        z-index: 39;
      }
      #sidebar-overlay.open { display: block; }
    }

    /* â”€â”€â”€ Chat History Scroll â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #chat-history {
      flex: 1;
      overflow-y: auto;
      padding: 6px 8px;
    }
    #chat-history::-webkit-scrollbar { width: 4px; }
    #chat-history::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 2px; }
    .dark #chat-history::-webkit-scrollbar-thumb { background: #374151; }

    /* â”€â”€â”€ Chat Item â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .chat-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 10px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 0.85rem;
      color: #374151;
      transition: background 0.15s;
      position: relative;
      user-select: none;
    }
    .dark .chat-item { color: #d1d5db; }
    .chat-item:hover, .chat-item.active {
      background: #e8eaf0;
    }
    .dark .chat-item:hover, .dark .chat-item.active {
      background: #1e2435;
    }
    .chat-item .chat-title {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .chat-item .chat-actions {
      display: none;
      gap: 2px;
    }
    .chat-item:hover .chat-actions { display: flex; }

    /* â”€â”€â”€ Main Content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #main {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
      height: 100dvh;
      overflow: hidden;
      background: #fff;
    }
    .dark #main { background: #1e2130; }

    /* â”€â”€â”€ Top Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #topbar {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 16px;
      border-bottom: 1px solid #e5e7eb;
      background: #fff;
      min-height: 56px;
      flex-shrink: 0;
    }
    .dark #topbar { background: #1e2130; border-color: #2a2f45; }

    /* â”€â”€â”€ Messages Area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px 0 8px;
      scroll-behavior: smooth;
    }
    #messages-container::-webkit-scrollbar { width: 6px; }
    #messages-container::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
    .dark #messages-container::-webkit-scrollbar-thumb { background: #374151; }

    #messages {
      max-width: 760px;
      margin: 0 auto;
      padding: 0 16px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    /* â”€â”€â”€ Message Bubbles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .msg-row {
      display: flex;
      gap: 10px;
      padding: 8px 0;
      animation: fadeUp 0.2s ease;
    }
    .msg-row.user { flex-direction: row-reverse; }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .msg-avatar {
      width: 32px; height: 32px;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
      margin-top: 2px;
    }
    .msg-avatar.ai {
      background: linear-gradient(135deg, #1a73e8, #0d9488);
      color: white;
    }
    .msg-avatar.user {
      background: linear-gradient(135deg, #8b5cf6, #ec4899);
      color: white;
      font-size: 13px;
      font-weight: 600;
    }

    .msg-bubble {
      max-width: min(80%, 620px);
      padding: 10px 14px;
      border-radius: 18px;
      font-size: 0.925rem;
      line-height: 1.6;
      word-break: break-word;
    }
    .msg-bubble.user {
      background: #e8f0fe;
      color: #1a1a2e;
      border-bottom-right-radius: 4px;
    }
    .dark .msg-bubble.user {
      background: #1e3a5f;
      color: #e2e8f0;
    }
    .msg-bubble.ai {
      background: transparent;
      color: #1a1a2e;
      border-bottom-left-radius: 4px;
      padding-left: 2px;
    }
    .dark .msg-bubble.ai { color: #e2e8f0; }

    /* â”€â”€â”€ Markdown Styles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .msg-bubble p { margin: 0 0 0.6em; }
    .msg-bubble p:last-child { margin-bottom: 0; }
    .msg-bubble h1,.msg-bubble h2,.msg-bubble h3 {
      font-weight: 600; margin: 0.8em 0 0.4em;
      line-height: 1.3;
    }
    .msg-bubble h1 { font-size: 1.25em; }
    .msg-bubble h2 { font-size: 1.1em; }
    .msg-bubble h3 { font-size: 1em; }
    .msg-bubble ul, .msg-bubble ol { padding-left: 1.4em; margin: 0.5em 0; }
    .msg-bubble li { margin: 0.25em 0; }
    .msg-bubble strong { font-weight: 600; }
    .msg-bubble em { font-style: italic; }
    .msg-bubble a { color: #1a73e8; text-decoration: underline; }
    .dark .msg-bubble a { color: #60a5fa; }
    .msg-bubble blockquote {
      border-left: 3px solid #d1d5db;
      padding-left: 12px;
      margin: 0.5em 0;
      color: #6b7280;
      font-style: italic;
    }
    .dark .msg-bubble blockquote { border-color: #4b5563; color: #9ca3af; }
    .msg-bubble hr { border: none; border-top: 1px solid #e5e7eb; margin: 0.8em 0; }
    .dark .msg-bubble hr { border-color: #374151; }

    /* Inline code */
    .msg-bubble code:not(.hljs) {
      background: #f1f5f9;
      color: #be123c;
      padding: 1px 5px;
      border-radius: 4px;
      font-family: 'DM Mono', monospace;
      font-size: 0.85em;
    }
    .dark .msg-bubble code:not(.hljs) {
      background: #1e293b;
      color: #f87171;
    }

    /* Code blocks */
    .code-block-wrap {
      position: relative;
      margin: 0.75em 0;
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid #e5e7eb;
    }
    .dark .code-block-wrap { border-color: #2a2f45; }

    .code-block-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #f1f5f9;
      padding: 6px 12px;
      font-family: 'DM Mono', monospace;
      font-size: 0.75rem;
      color: #6b7280;
    }
    .dark .code-block-header { background: #1e293b; color: #9ca3af; }

    .code-block-wrap pre {
      margin: 0;
      padding: 14px 16px;
      overflow-x: auto;
      font-size: 0.85rem;
      line-height: 1.6;
      background: #fff;
    }
    .dark .code-block-wrap pre { background: #0d1117; }

    .copy-btn {
      background: transparent;
      border: 1px solid #d1d5db;
      color: #6b7280;
      padding: 2px 8px;
      border-radius: 5px;
      font-size: 0.72rem;
      cursor: pointer;
      font-family: 'DM Sans', sans-serif;
      transition: all 0.15s;
    }
    .copy-btn:hover { background: #e5e7eb; color: #374151; }
    .dark .copy-btn { border-color: #374151; color: #9ca3af; }
    .dark .copy-btn:hover { background: #374151; color: #e5e7eb; }

    /* â”€â”€â”€ Typing cursor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .typing-cursor {
      display: inline-block;
      width: 2px; height: 1em;
      background: #1a73e8;
      margin-left: 2px;
      vertical-align: middle;
      animation: blink 0.85s infinite;
      border-radius: 1px;
    }
    @keyframes blink {
      0%,100% { opacity: 1; }
      50% { opacity: 0; }
    }

    /* â”€â”€â”€ Welcome Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #welcome {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      flex: 1;
      padding: 40px 20px;
      gap: 16px;
      text-align: center;
    }
    .welcome-logo {
      width: 64px; height: 64px;
      background: linear-gradient(135deg, #1a73e8, #0d9488);
      border-radius: 20px;
      display: flex; align-items: center; justify-content: center;
      font-size: 28px;
      color: white;
      box-shadow: 0 8px 32px rgba(26,115,232,0.25);
    }
    .welcome-title {
      font-size: 1.6rem;
      font-weight: 600;
      color: #1a1a2e;
      letter-spacing: -0.02em;
    }
    .dark .welcome-title { color: #f1f5f9; }
    .welcome-sub {
      color: #6b7280;
      font-size: 0.95rem;
      max-width: 360px;
    }
    .dark .welcome-sub { color: #9ca3af; }
    .suggestion-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      max-width: 480px;
      margin-top: 8px;
    }
    .chip {
      background: #f0f4f9;
      border: 1px solid #e2e8f0;
      color: #374151;
      padding: 8px 14px;
      border-radius: 20px;
      font-size: 0.83rem;
      cursor: pointer;
      transition: all 0.15s;
    }
    .chip:hover { background: #e8f0fe; border-color: #1a73e8; color: #1a73e8; }
    .dark .chip { background: #1e293b; border-color: #2a2f45; color: #d1d5db; }
    .dark .chip:hover { background: #1e3a5f; border-color: #3b82f6; color: #93c5fd; }

    /* â”€â”€â”€ Input Area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #input-area {
      flex-shrink: 0;
      padding: 12px 16px 16px;
      background: #fff;
      border-top: 1px solid #e5e7eb;
      /* keyboard-safe on iOS */
      padding-bottom: max(16px, env(safe-area-inset-bottom));
    }
    .dark #input-area { background: #1e2130; border-color: #2a2f45; }

    #input-wrap {
      max-width: 760px;
      margin: 0 auto;
      display: flex;
      align-items: flex-end;
      gap: 8px;
      background: #f0f4f9;
      border: 1.5px solid #e2e8f0;
      border-radius: 24px;
      padding: 8px 8px 8px 16px;
      transition: border-color 0.2s;
    }
    .dark #input-wrap {
      background: #131722;
      border-color: #2a2f45;
    }
    #input-wrap:focus-within {
      border-color: #1a73e8;
      box-shadow: 0 0 0 3px rgba(26,115,232,0.12);
    }
    .dark #input-wrap:focus-within { border-color: #3b82f6; }

    #user-input {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.95rem;
      color: #1a1a2e;
      resize: none;
      line-height: 1.5;
      max-height: 180px;
      min-height: 24px;
      overflow-y: auto;
      padding: 2px 0;
    }
    .dark #user-input { color: #f1f5f9; }
    #user-input::placeholder { color: #9ca3af; }
    #user-input::-webkit-scrollbar { width: 0; }

    #send-btn {
      width: 38px; height: 38px;
      border-radius: 50%;
      border: none;
      background: #1a73e8;
      color: white;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      flex-shrink: 0;
      transition: all 0.15s;
      font-size: 16px;
    }
    #send-btn:hover:not(:disabled) { background: #1557b0; transform: scale(1.05); }
    #send-btn:disabled { background: #d1d5db; cursor: not-allowed; transform: none; }
    .dark #send-btn:disabled { background: #374151; }

    #stop-btn {
      width: 38px; height: 38px;
      border-radius: 50%;
      border: 2px solid #ef4444;
      background: transparent;
      color: #ef4444;
      display: none;
      align-items: center; justify-content: center;
      cursor: pointer;
      flex-shrink: 0;
      transition: all 0.15s;
      font-size: 14px;
    }
    #stop-btn:hover { background: rgba(239,68,68,0.1); }
    #stop-btn.visible { display: flex; }

    .input-footer {
      max-width: 760px;
      margin: 6px auto 0;
      text-align: center;
      font-size: 0.72rem;
      color: #9ca3af;
    }

    /* â”€â”€â”€ Modals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .modal-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.4);
      backdrop-filter: blur(4px);
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      animation: fadeIn 0.2s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to   { opacity: 1; }
    }
    .modal-box {
      background: #fff;
      border-radius: 16px;
      padding: 24px;
      width: 100%;
      max-width: 480px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.2);
      animation: slideUp 0.25s cubic-bezier(0.4,0,0.2,1);
    }
    .dark .modal-box { background: #1e2130; }
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .modal-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #1a1a2e;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .dark .modal-title { color: #f1f5f9; }

    /* â”€â”€â”€ Form Controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    label {
      display: block;
      font-size: 0.82rem;
      font-weight: 500;
      color: #374151;
      margin-bottom: 5px;
    }
    .dark label { color: #d1d5db; }

    input[type="text"], input[type="password"], select, textarea {
      width: 100%;
      padding: 9px 12px;
      border: 1.5px solid #e2e8f0;
      border-radius: 8px;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.9rem;
      color: #1a1a2e;
      background: #f8f9fa;
      outline: none;
      transition: border-color 0.2s;
      margin-bottom: 14px;
    }
    .dark input[type="text"], .dark input[type="password"],
    .dark select, .dark textarea {
      background: #131722;
      border-color: #2a2f45;
      color: #f1f5f9;
    }
    input:focus, select:focus, textarea:focus {
      border-color: #1a73e8;
      box-shadow: 0 0 0 3px rgba(26,115,232,0.12);
    }
    textarea { resize: vertical; min-height: 80px; }

    /* â”€â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .btn {
      padding: 9px 18px;
      border-radius: 8px;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.88rem;
      font-weight: 500;
      cursor: pointer;
      border: none;
      transition: all 0.15s;
    }
    .btn-primary {
      background: #1a73e8;
      color: white;
    }
    .btn-primary:hover { background: #1557b0; }
    .btn-ghost {
      background: transparent;
      color: #6b7280;
      border: 1.5px solid #e2e8f0;
    }
    .btn-ghost:hover { background: #f0f4f9; color: #374151; }
    .dark .btn-ghost { border-color: #2a2f45; color: #9ca3af; }
    .dark .btn-ghost:hover { background: #1e293b; color: #d1d5db; }
    .btn-danger {
      background: transparent;
      color: #ef4444;
      border: 1.5px solid #fecaca;
    }
    .btn-danger:hover { background: rgba(239,68,68,0.08); }

    /* â”€â”€â”€ Icon Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .icon-btn {
      width: 34px; height: 34px;
      border-radius: 8px;
      border: none;
      background: transparent;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      color: #6b7280;
      font-size: 16px;
      transition: all 0.15s;
      flex-shrink: 0;
    }
    .icon-btn:hover { background: #f0f4f9; color: #374151; }
    .dark .icon-btn { color: #9ca3af; }
    .dark .icon-btn:hover { background: #1e293b; color: #e5e7eb; }

    /* â”€â”€â”€ Date separators â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .date-sep {
      text-align: center;
      font-size: 0.72rem;
      color: #9ca3af;
      padding: 4px 0;
      font-weight: 500;
    }

    /* â”€â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: #1a1a2e;
      color: #f1f5f9;
      padding: 10px 18px;
      border-radius: 24px;
      font-size: 0.85rem;
      z-index: 200;
      opacity: 0;
      transition: all 0.25s ease;
      pointer-events: none;
      white-space: nowrap;
    }
    .dark #toast { background: #f1f5f9; color: #1a1a2e; }
    #toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    /* â”€â”€â”€ Scrollbar global â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
    .dark ::-webkit-scrollbar-thumb { background: #374151; }

    /* â”€â”€â”€ Section labels in sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .sidebar-section {
      padding: 10px 12px 4px;
      font-size: 0.72rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #9ca3af;
    }

    /* â”€â”€â”€ Error message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .error-bubble {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      background: #fef2f2;
      border: 1px solid #fecaca;
      border-radius: 12px;
      padding: 10px 14px;
      font-size: 0.88rem;
      color: #dc2626;
      margin: 4px 0;
    }
    .dark .error-bubble { background: #450a0a; border-color: #7f1d1d; color: #fca5a5; }

    /* â”€â”€â”€ Thinking block â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .thinking-indicator {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: #f0f4ff;
      border: 1px solid #c7d7fe;
      border-radius: 10px;
      padding: 7px 12px;
      font-size: 0.82rem;
      color: #4f6ef7;
      margin-bottom: 8px;
      font-style: italic;
    }
    .dark .thinking-indicator {
      background: #1a1f3a;
      border-color: #2d3a6e;
      color: #818cf8;
    }
    .thinking-dots span {
      display: inline-block;
      width: 5px; height: 5px;
      background: #4f6ef7;
      border-radius: 50%;
      margin: 0 1px;
      animation: thinkBounce 1.2s infinite ease-in-out;
    }
    .dark .thinking-dots span { background: #818cf8; }
    .thinking-dots span:nth-child(1) { animation-delay: 0s; }
    .thinking-dots span:nth-child(2) { animation-delay: 0.2s; }
    .thinking-dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes thinkBounce {
      0%, 80%, 100% { transform: translateY(0); opacity: 0.4; }
      40%            { transform: translateY(-4px); opacity: 1; }
    }
    .think-block { margin-bottom: 10px; }
    .think-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #f0f4ff;
      border: 1px solid #c7d7fe;
      border-radius: 8px;
      padding: 5px 11px;
      font-size: 0.8rem;
      color: #4f6ef7;
      cursor: pointer;
      font-family: 'DM Sans', sans-serif;
      transition: all 0.15s;
      margin-bottom: 0;
      font-style: italic;
    }
    .think-toggle:hover { background: #e0e8ff; }
    .dark .think-toggle { background: #1a1f3a; border-color: #2d3a6e; color: #818cf8; }
    .dark .think-toggle:hover { background: #1e2550; }
    .think-toggle .think-arrow { font-style: normal; display:inline-block; transition: transform 0.2s; }
    .think-toggle.open .think-arrow { transform: rotate(90deg); }
    .think-content {
      display: none;
      background: #f8f9ff;
      border: 1px solid #dde5fe;
      border-top: none;
      border-radius: 0 0 8px 8px;
      padding: 10px 14px;
      font-size: 0.82rem;
      color: #5a6892;
      line-height: 1.65;
      font-style: italic;
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 260px;
      overflow-y: auto;
    }
    .think-content.open { display: block; animation: fadeUp 0.2s ease; }
    .dark .think-content { background: #131828; border-color: #252f5c; color: #7b86b8; }
  </style>
</head>
<body>

<!-- â”€â”€â”€ Loader â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="loading">
  <div style="text-align:center; display:flex; flex-direction:column; align-items:center; gap:12px;">
    <div style="width:44px;height:44px;background:linear-gradient(135deg,#1a73e8,#0d9488);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px;">âœ¦</div>
    <span>Loading AI Chatâ€¦</span>
  </div>
</div>

<!-- â”€â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="toast"></div>

<!-- â”€â”€â”€ App Shell â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="app">

  <!-- Sidebar Overlay (mobile) -->
  <div id="sidebar-overlay" onclick="closeSidebar()"></div>

  <!-- â”€â”€â”€ LEFT SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <aside id="sidebar">
    <div style="padding:12px 10px 8px; display:flex; align-items:center; gap:8px; flex-shrink:0;">
      <div style="width:32px;height:32px;background:linear-gradient(135deg,#1a73e8,#0d9488);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:14px;color:white;flex-shrink:0;">âœ¦</div>
      <span style="font-weight:600;font-size:0.95rem;color:#1a1a2e;" class="dark:text-slate-100" id="app-name">Universal AI</span>
      <!-- close sidebar on mobile -->
      <button class="icon-btn" style="margin-left:auto;" onclick="closeSidebar()" title="Close sidebar">âœ•</button>
    </div>

    <!-- New Chat -->
    <div style="padding:4px 10px 6px;">
      <button onclick="newChat()" style="width:100%;padding:9px 14px;background:#e8f0fe;border:none;border-radius:10px;display:flex;align-items:center;gap:8px;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:0.88rem;font-weight:500;color:#1a73e8;transition:all 0.15s;" id="new-chat-btn">
        <span style="font-size:16px;">ï¼‹</span> New Chat
      </button>
    </div>

    <div class="sidebar-section">Recent Chats</div>

    <div id="chat-history"></div>

    <!-- Sidebar bottom -->
    <div style="flex-shrink:0;padding:10px;border-top:1px solid #e5e7eb;display:flex;flex-direction:column;gap:4px;" id="sidebar-bottom">
      <button class="icon-btn" style="width:100%;border-radius:10px;justify-content:flex-start;gap:8px;padding:0 12px;height:38px;font-size:0.875rem;" onclick="openSettings()">
        <span>âš™ï¸</span> Settings
      </button>
      <button class="icon-btn" style="width:100%;border-radius:10px;justify-content:flex-start;gap:8px;padding:0 12px;height:38px;font-size:0.875rem;" onclick="toggleDark()">
        <span id="dark-icon">ğŸŒ™</span> <span id="dark-label">Dark Mode</span>
      </button>
    </div>
  </aside>

  <!-- â”€â”€â”€ MAIN AREA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="main">

    <!-- Top Bar -->
    <div id="topbar">
      <!-- Hamburger (mobile) -->
      <button class="icon-btn" id="hamburger" onclick="openSidebar()" title="Menu" style="font-size:18px;">â˜°</button>

      <div style="flex:1;min-width:0;">
        <div id="chat-name-display" style="font-weight:600;font-size:0.95rem;color:#1a1a2e;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" class="dark-text">New Chat</div>
        <div id="model-display" style="font-size:0.75rem;color:#9ca3af;margin-top:1px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">deepseek/deepseek-r1:free</div>
      </div>

      <button class="icon-btn" onclick="openSystemPrompt()" title="System Prompt" style="font-size:16px;">ğŸ“‹</button>
      <button class="icon-btn" onclick="openSettings()" title="Settings" style="font-size:16px;">âš™ï¸</button>
    </div>

    <!-- Messages -->
    <div id="messages-container">
      <!-- Welcome shown when no messages -->
      <div id="welcome">
        <div class="welcome-logo">âœ¦</div>
        <div class="welcome-title">Hello, how can I help?</div>
        <div class="welcome-sub">Ask me anything â€” I'm powered by OpenRouter and can use any model you configure.</div>
        <div class="suggestion-chips">
          <div class="chip" onclick="sendSuggestion('Explain quantum computing in simple terms')">âš›ï¸ Explain quantum computing</div>
          <div class="chip" onclick="sendSuggestion('Write a Python function to reverse a string')">ğŸ Write a Python function</div>
          <div class="chip" onclick="sendSuggestion('What are the best practices for REST API design?')">ğŸŒ REST API best practices</div>
          <div class="chip" onclick="sendSuggestion('Summarize the history of the internet')">ğŸ“œ History of the internet</div>
        </div>
      </div>
      <div id="messages"></div>
    </div>

    <!-- Input Area -->
    <div id="input-area">
      <div id="input-wrap">
        <button class="icon-btn" onclick="openSystemPrompt()" title="System prompt" style="font-size:15px;flex-shrink:0;margin-bottom:2px;">ğŸ“‹</button>
        <textarea
          id="user-input"
          placeholder="Message AIâ€¦"
          rows="1"
          onkeydown="handleInputKey(event)"
          oninput="autoResize(this)"
        ></textarea>
        <button id="stop-btn" onclick="stopGeneration()" title="Stop">â¹</button>
        <button id="send-btn" onclick="sendMessage()" title="Send (Enter)">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <line x1="22" y1="2" x2="11" y2="13"/>
            <polygon points="22 2 15 22 11 13 2 9 22 2"/>
          </svg>
        </button>
      </div>
      <div class="input-footer">AI can make mistakes. Verify important information.</div>
    </div>

  </div><!-- end #main -->
</div><!-- end #app -->

<!-- â”€â”€â”€ SETTINGS MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-overlay" id="settings-modal" style="display:none;" onclick="closeOnOverlay(event,'settings-modal')">
  <div class="modal-box" onclick="event.stopPropagation()">
    <div class="modal-title">âš™ï¸ Settings</div>

    <label for="api-key-input">OpenRouter API Key</label>
    <input type="password" id="api-key-input" placeholder="sk-or-v1-â€¦" autocomplete="off" />

    <label for="model-input">Model</label>
    <input type="text" id="model-input" placeholder="liquid/lfm-2.5-1.2b-thinking:free" />
    <div style="font-size:0.78rem;color:#9ca3af;margin-top:-10px;margin-bottom:14px;">
      Current: <code style="font-size:0.78rem;">liquid/lfm-2.5-1.2b-thinking:free</code> Â· Others: <code style="font-size:0.78rem;">deepseek/deepseek-r1:free</code>, <code style="font-size:0.78rem;">openai/gpt-4o</code>
    </div>

    <label for="max-tokens-input">Max Tokens</label>
    <input type="text" id="max-tokens-input" placeholder="4096" />

    <label for="temperature-input">Temperature (0 â€“ 2)</label>
    <input type="text" id="temperature-input" placeholder="0.7" />

    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:4px;">
      <button class="btn btn-ghost" onclick="closeModal('settings-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveSettings()">Save</button>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ SYSTEM PROMPT MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-overlay" id="sysprompt-modal" style="display:none;" onclick="closeOnOverlay(event,'sysprompt-modal')">
  <div class="modal-box" onclick="event.stopPropagation()">
    <div class="modal-title">ğŸ“‹ System Prompt</div>
    <label for="sysprompt-input">Define the AI's behavior, persona, or instructions</label>
    <textarea id="sysprompt-input" placeholder="You are a helpful AI assistantâ€¦" style="min-height:140px;"></textarea>
    <div style="font-size:0.78rem;color:#9ca3af;margin-top:-10px;margin-bottom:14px;">
      This applies globally and is sent with every message.
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button class="btn btn-ghost" onclick="closeModal('sysprompt-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveSystemPrompt()">Save</button>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ RENAME CHAT MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-overlay" id="rename-modal" style="display:none;" onclick="closeOnOverlay(event,'rename-modal')">
  <div class="modal-box" onclick="event.stopPropagation()">
    <div class="modal-title">âœï¸ Rename Chat</div>
    <label for="rename-input">Chat Name</label>
    <input type="text" id="rename-input" placeholder="Enter a nameâ€¦" />
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button class="btn btn-ghost" onclick="closeModal('rename-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="confirmRename()">Rename</button>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ MAIN SCRIPT (end of body) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<script>
(function() {
  'use strict';

  // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var state = {
    chats: {},           // { id: { id, name, messages, createdAt } }
    currentChatId: null,
    settings: {
      apiKey: '',
      model: 'liquid/lfm-2.5-1.2b-thinking:free',
      maxTokens: 4096,
      temperature: 0.7,
      systemPrompt: 'You are a helpful, harmless, and honest AI assistant.',
      darkMode: false
    },
    isStreaming: false,
    abortController: null,
    renamingChatId: null
  };

  // â”€â”€ Persistence â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function saveState() {
    try {
      localStorage.setItem('uai_chats', JSON.stringify(state.chats));
      localStorage.setItem('uai_settings', JSON.stringify(state.settings));
      localStorage.setItem('uai_currentChat', state.currentChatId || '');
    } catch(e) { /* storage full or private mode */ }
  }

  function loadState() {
    try {
      var chats = localStorage.getItem('uai_chats');
      var settings = localStorage.getItem('uai_settings');
      var cur = localStorage.getItem('uai_currentChat');
      if (chats) state.chats = JSON.parse(chats);
      if (settings) {
        var s = JSON.parse(settings);
        Object.assign(state.settings, s);
      }
      if (cur && state.chats[cur]) state.currentChatId = cur;
    } catch(e) { /* corrupt data */ }
  }

  // â”€â”€ ID generator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function genId() {
    return Date.now().toString(36) + Math.random().toString(36).slice(2, 7);
  }

  // â”€â”€ Dark mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function applyDark() {
    var html = document.documentElement;
    if (state.settings.darkMode) {
      html.classList.add('dark');
      document.getElementById('dark-icon').textContent = 'â˜€ï¸';
      document.getElementById('dark-label').textContent = 'Light Mode';
      document.getElementById('hljs-light-theme').disabled = true;
      document.getElementById('hljs-dark-theme').disabled = false;
    } else {
      html.classList.remove('dark');
      document.getElementById('dark-icon').textContent = 'ğŸŒ™';
      document.getElementById('dark-label').textContent = 'Dark Mode';
      document.getElementById('hljs-light-theme').disabled = false;
      document.getElementById('hljs-dark-theme').disabled = true;
    }
    // body/app bg
    var app = document.getElementById('app');
    var main = document.getElementById('main');
    var topbar = document.getElementById('topbar');
    var inputArea = document.getElementById('input-area');
    var sidebar = document.getElementById('sidebar');
    var sidebarBottom = document.getElementById('sidebar-bottom');
    var nameDisp = document.getElementById('chat-name-display');

    if (state.settings.darkMode) {
      app.style.background = '#1e2130';
      main.style.background = '#1e2130';
      topbar.style.background = '#1e2130';
      topbar.style.borderColor = '#2a2f45';
      inputArea.style.background = '#1e2130';
      inputArea.style.borderColor = '#2a2f45';
      sidebar.style.background = '#131722';
      sidebar.style.borderColor = '#2a2f45';
      sidebarBottom.style.borderColor = '#2a2f45';
      nameDisp.style.color = '#f1f5f9';
    } else {
      app.style.background = '';
      main.style.background = '';
      topbar.style.background = '';
      topbar.style.borderColor = '';
      inputArea.style.background = '';
      inputArea.style.borderColor = '';
      sidebar.style.background = '';
      sidebar.style.borderColor = '';
      sidebarBottom.style.borderColor = '';
      nameDisp.style.color = '';
    }
  }

  window.toggleDark = function() {
    state.settings.darkMode = !state.settings.darkMode;
    applyDark();
    saveState();
  };

  // â”€â”€ Chat Management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function createChat() {
    var id = genId();
    state.chats[id] = {
      id: id,
      name: 'New Chat',
      messages: [],
      createdAt: Date.now()
    };
    return id;
  }

  window.newChat = function() {
    var id = createChat();
    state.currentChatId = id;
    saveState();
    renderSidebar();
    renderMessages();
    document.getElementById('chat-name-display').textContent = 'New Chat';
    closeSidebar();
    document.getElementById('user-input').focus();
  };

  function switchChat(id) {
    if (!state.chats[id]) return;
    state.currentChatId = id;
    saveState();
    renderSidebar();
    renderMessages();
    document.getElementById('chat-name-display').textContent = state.chats[id].name;
    closeSidebar();
  }

  window.deleteChat = function(id, e) {
    if (e) e.stopPropagation();
    if (!confirm('Delete this chat?')) return;
    delete state.chats[id];
    if (state.currentChatId === id) {
      state.currentChatId = null;
    }
    saveState();
    renderSidebar();
    if (!state.currentChatId) {
      window.newChat();
    }
  };

  window.startRename = function(id, e) {
    if (e) e.stopPropagation();
    state.renamingChatId = id;
    document.getElementById('rename-input').value = state.chats[id] ? state.chats[id].name : '';
    openModal('rename-modal');
    setTimeout(function() { document.getElementById('rename-input').focus(); }, 100);
  };

  window.confirmRename = function() {
    var val = document.getElementById('rename-input').value.trim();
    if (!val) return;
    if (state.renamingChatId && state.chats[state.renamingChatId]) {
      state.chats[state.renamingChatId].name = val;
      if (state.currentChatId === state.renamingChatId) {
        document.getElementById('chat-name-display').textContent = val;
      }
    }
    closeModal('rename-modal');
    saveState();
    renderSidebar();
  };

  // â”€â”€ Sidebar render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderSidebar() {
    var el = document.getElementById('chat-history');
    var ids = Object.keys(state.chats).sort(function(a, b) {
      return (state.chats[b].createdAt || 0) - (state.chats[a].createdAt || 0);
    });
    if (ids.length === 0) {
      el.innerHTML = '<div style="padding:12px 14px;font-size:0.82rem;color:#9ca3af;font-style:italic;">No chats yet</div>';
      return;
    }
    var html = '';
    ids.forEach(function(id) {
      var chat = state.chats[id];
      var isActive = id === state.currentChatId;
      var preview = '';
      if (chat.messages && chat.messages.length > 0) {
        var last = chat.messages[chat.messages.length - 1];
        preview = (last.content || '').slice(0, 40);
      }
      html += '<div class="chat-item' + (isActive ? ' active' : '') + '" onclick="switchChat(\'' + id + '\')">';
      html += '<span style="font-size:14px;flex-shrink:0;">ğŸ’¬</span>';
      html += '<span class="chat-title" title="' + esc(chat.name) + '">' + esc(chat.name) + '</span>';
      html += '<span class="chat-actions">';
      html += '<button class="icon-btn" style="width:24px;height:24px;font-size:12px;" onclick="startRename(\'' + id + '\',event)" title="Rename">âœï¸</button>';
      html += '<button class="icon-btn" style="width:24px;height:24px;font-size:12px;color:#ef4444;" onclick="deleteChat(\'' + id + '\',event)" title="Delete">ğŸ—‘</button>';
      html += '</span>';
      html += '</div>';
    });
    el.innerHTML = html;
  }

  function esc(str) {
    return (str || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  // â”€â”€ Mobile sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  window.openSidebar = function() {
    document.getElementById('sidebar').classList.add('open');
    document.getElementById('sidebar-overlay').classList.add('open');
  };
  window.closeSidebar = function() {
    document.getElementById('sidebar').classList.remove('open');
    document.getElementById('sidebar-overlay').classList.remove('open');
  };

  // â”€â”€ Modals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function openModal(id) {
    document.getElementById(id).style.display = 'flex';
  }
  function closeModal(id) {
    document.getElementById(id).style.display = 'none';
  }
  window.closeModal = closeModal;
  window.closeOnOverlay = function(e, id) {
    if (e.target === document.getElementById(id)) closeModal(id);
  };

  window.openSettings = function() {
    document.getElementById('api-key-input').value = state.settings.apiKey || '';
    document.getElementById('model-input').value = state.settings.model || 'liquid/lfm-2.5-1.2b-thinking:free';
    document.getElementById('max-tokens-input').value = state.settings.maxTokens || 4096;
    document.getElementById('temperature-input').value = state.settings.temperature !== undefined ? state.settings.temperature : 0.7;
    openModal('settings-modal');
    setTimeout(function() { document.getElementById('api-key-input').focus(); }, 100);
  };

  window.saveSettings = function() {
    state.settings.apiKey = document.getElementById('api-key-input').value.trim();
    state.settings.model = document.getElementById('model-input').value.trim() || 'liquid/lfm-2.5-1.2b-thinking:free';
    var mt = parseInt(document.getElementById('max-tokens-input').value);
    state.settings.maxTokens = isNaN(mt) ? 4096 : Math.max(1, Math.min(32000, mt));
    var temp = parseFloat(document.getElementById('temperature-input').value);
    state.settings.temperature = isNaN(temp) ? 0.7 : Math.max(0, Math.min(2, temp));
    saveState();
    closeModal('settings-modal');
    document.getElementById('model-display').textContent = state.settings.model;
    showToast('Settings saved âœ“');
  };

  window.openSystemPrompt = function() {
    document.getElementById('sysprompt-input').value = state.settings.systemPrompt || '';
    openModal('sysprompt-modal');
    setTimeout(function() { document.getElementById('sysprompt-input').focus(); }, 100);
  };

  window.saveSystemPrompt = function() {
    state.settings.systemPrompt = document.getElementById('sysprompt-input').value.trim();
    saveState();
    closeModal('sysprompt-modal');
    showToast('System prompt saved âœ“');
  };

  // â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var toastTimer = null;
  function showToast(msg) {
    var t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    if (toastTimer) clearTimeout(toastTimer);
    toastTimer = setTimeout(function() { t.classList.remove('show'); }, 2500);
  }
  window.showToast = showToast;

  // â”€â”€ Markdown renderer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderMarkdown(text) {
    if (typeof marked === 'undefined') return esc(text);

    // Configure marked
    marked.setOptions({
      breaks: true,
      gfm: true
    });

    // Custom renderer for code blocks
    var renderer = new marked.Renderer();
    renderer.code = function(code, lang) {
      var language = lang || 'plaintext';
      var highlighted = '';
      try {
        if (window.hljs && hljs.getLanguage(language)) {
          highlighted = hljs.highlight(code, { language: language }).value;
        } else if (window.hljs) {
          highlighted = hljs.highlightAuto(code).value;
        } else {
          highlighted = esc(code);
        }
      } catch(e) {
        highlighted = esc(code);
      }
      var id = 'cb-' + genId();
      return '<div class="code-block-wrap">' +
        '<div class="code-block-header">' +
          '<span>' + esc(language) + '</span>' +
          '<button class="copy-btn" onclick="copyCode(\'' + id + '\')">Copy</button>' +
        '</div>' +
        '<pre><code id="' + id + '" class="hljs">' + highlighted + '</code></pre>' +
      '</div>';
    };

    try {
      return marked.parse(text, { renderer: renderer });
    } catch(e) {
      return '<p>' + esc(text) + '</p>';
    }
  }

  window.copyCode = function(id) {
    var el = document.getElementById(id);
    if (!el) return;
    var text = el.textContent || el.innerText;
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text).then(function() {
        showToast('Copied to clipboard âœ“');
      }).catch(function() {
        fallbackCopy(text);
      });
    } else {
      fallbackCopy(text);
    }
  };

  function fallbackCopy(text) {
    var ta = document.createElement('textarea');
    ta.value = text;
    ta.style.position = 'fixed';
    ta.style.opacity = '0';
    document.body.appendChild(ta);
    ta.focus();
    ta.select();
    try { document.execCommand('copy'); showToast('Copied âœ“'); } catch(e) {}
    document.body.removeChild(ta);
  }

  // â”€â”€ Message Rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderMessages() {
    var chat = state.chats[state.currentChatId];
    var msgs = (chat && chat.messages) ? chat.messages : [];

    var welcome = document.getElementById('welcome');
    var messagesEl = document.getElementById('messages');

    if (msgs.length === 0) {
      welcome.style.display = 'flex';
      messagesEl.style.display = 'none';
      messagesEl.innerHTML = '';
      return;
    }

    welcome.style.display = 'none';
    messagesEl.style.display = 'flex';

    var html = '';
    msgs.forEach(function(msg, i) {
      html += buildMsgHTML(msg);
    });
    messagesEl.innerHTML = html;
    scrollToBottom();
  }

  function buildMsgHTML(msg) {
    var isUser = msg.role === 'user';
    var content = msg.content || '';

    if (isUser) {
      return '<div class="msg-row user">' +
        '<div class="msg-avatar user">U</div>' +
        '<div class="msg-bubble user">' + esc(content).replace(/\n/g, '<br>') + '</div>' +
      '</div>';
    } else {
      return '<div class="msg-row ai">' +
        '<div class="msg-avatar ai">âœ¦</div>' +
        '<div class="msg-bubble ai">' + renderWithThinking(content, false) + '</div>' +
      '</div>';
    }
  }

  function appendMessageEl(msg, streaming) {
    var welcome = document.getElementById('welcome');
    var messagesEl = document.getElementById('messages');
    welcome.style.display = 'none';
    messagesEl.style.display = 'flex';

    var div = document.createElement('div');
    div.className = 'msg-row ' + (msg.role === 'user' ? 'user' : 'ai');
    div.setAttribute('data-msg-id', msg.id || '');

    var isUser = msg.role === 'user';
    var content = msg.content || '';

    if (isUser) {
      div.innerHTML =
        '<div class="msg-avatar user">U</div>' +
        '<div class="msg-bubble user">' + esc(content).replace(/\n/g,'<br>') + '</div>';
    } else {
      var bubbleContent = streaming ? '<span class="typing-cursor"></span>' : renderMarkdown(content);
      div.innerHTML =
        '<div class="msg-avatar ai">âœ¦</div>' +
        '<div class="msg-bubble ai" id="streaming-bubble">' + bubbleContent + '</div>';
    }

    messagesEl.appendChild(div);
    scrollToBottom();
    return div;
  }

  function updateStreamingBubble(rawText, done) {
    var bubble = document.getElementById('streaming-bubble');
    if (!bubble) return;
    if (done) {
      bubble.removeAttribute('id');
      bubble.innerHTML = renderWithThinking(rawText, false);
    } else {
      bubble.innerHTML = renderWithThinkingLive(rawText);
    }
    scrollToBottom();
  }

  // Renders final message: extracts <think>â€¦</think> as collapsible block
  function renderWithThinking(rawText, isLive) {
    if (!rawText) return '';
    // Extract all <think>...</think> blocks
    var thinkRegex = /<think>([\s\S]*?)<\/think>/gi;
    var thinkBlocks = [];
    var match;
    while ((match = thinkRegex.exec(rawText)) !== null) {
      thinkBlocks.push(match[1].trim());
    }
    // Remove <think> blocks from visible content
    var cleanText = rawText.replace(/<think>[\s\S]*?<\/think>/gi, '').trim();

    var html = '';

    // Render thinking blocks as collapsible
    if (thinkBlocks.length > 0) {
      var blockId = 'think-' + genId();
      var combinedThink = thinkBlocks.join('\n\n---\n\n');
      html += '<div class="think-block">';
      html += '<button class="think-toggle" onclick="toggleThink(\'' + blockId + '\',this)" title="View model reasoning">';
      html += '<span class="think-arrow">â–¶</span> ğŸ§  View reasoning (' + Math.round(combinedThink.length / 5) + ' tokens est.)';
      html += '</button>';
      html += '<div class="think-content" id="' + blockId + '">' + esc(combinedThink) + '</div>';
      html += '</div>';
    }

    // Render main answer
    if (cleanText) {
      html += renderMarkdown(cleanText);
    } else if (thinkBlocks.length > 0 && !cleanText) {
      html += '<span style="color:#9ca3af;font-style:italic;">Thinking complete.</span>';
    }

    return html;
  }

  // Live rendering during streaming â€” detects partial think tags
  function renderWithThinkingLive(rawText) {
    if (!rawText) return '<span class="typing-cursor"></span>';

    var inThink = false;
    var thinkDone = false;
    var thinkContent = '';
    var afterThink = '';

    // Check if we're currently inside an open <think> tag
    var openIdx = rawText.lastIndexOf('<think>');
    var closeIdx = rawText.lastIndexOf('</think>');

    if (openIdx !== -1 && closeIdx < openIdx) {
      // We're inside a think block (not yet closed)
      inThink = true;
      thinkContent = rawText.slice(openIdx + 7); // after <think>
    } else if (openIdx !== -1 && closeIdx > openIdx) {
      // Think block complete
      thinkDone = true;
      var thinkRegex2 = /<think>([\s\S]*?)<\/think>/gi;
      var m2;
      var blocks2 = [];
      while ((m2 = thinkRegex2.exec(rawText)) !== null) blocks2.push(m2[1].trim());
      thinkContent = blocks2.join('\n\n---\n\n');
      afterThink = rawText.replace(/<think>[\s\S]*?<\/think>/gi, '').trim();
    }

    var html = '';

    if (inThink) {
      // Show animated thinking indicator
      html += '<div class="thinking-indicator">';
      html += '<span class="thinking-dots"><span></span><span></span><span></span></span>';
      html += 'Thinkingâ€¦';
      html += '</div>';
    } else if (thinkDone && thinkContent) {
      // Render collapsed think block
      var blockId = 'think-live-' + genId();
      html += '<div class="think-block">';
      html += '<button class="think-toggle" onclick="toggleThink(\'' + blockId + '\',this)">';
      html += '<span class="think-arrow">â–¶</span> ğŸ§  View reasoning';
      html += '</button>';
      html += '<div class="think-content" id="' + blockId + '">' + esc(thinkContent) + '</div>';
      html += '</div>';
    }

    // Render answer content with cursor
    if (afterThink || (!inThink && !thinkDone)) {
      var visibleText = afterThink || rawText;
      html += '<span>' + esc(visibleText).replace(/\n/g, '<br>') + '</span>';
    }

    html += '<span class="typing-cursor"></span>';
    return html;
  }

  window.toggleThink = function(id, btn) {
    var el = document.getElementById(id);
    if (!el) return;
    el.classList.toggle('open');
    if (btn) btn.classList.toggle('open');
  };

  function scrollToBottom() {
    var container = document.getElementById('messages-container');
    container.scrollTop = container.scrollHeight;
  }

  // â”€â”€ Input Handling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  window.autoResize = function(el) {
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 180) + 'px';
  };

  window.handleInputKey = function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      if (!state.isStreaming) sendMessage();
    }
  };

  window.sendSuggestion = function(text) {
    document.getElementById('user-input').value = text;
    sendMessage();
  };

  window.sendMessage = function() {
    var input = document.getElementById('user-input');
    var text = input.value.trim();
    if (!text || state.isStreaming) return;

    if (!state.settings.apiKey) {
      showToast('âš ï¸ Please set your API key in Settings');
      openSettings();
      return;
    }

    // Ensure we have a current chat
    if (!state.currentChatId || !state.chats[state.currentChatId]) {
      var id = createChat();
      state.currentChatId = id;
    }

    var chat = state.chats[state.currentChatId];

    // Add user message
    var userMsg = { role: 'user', content: text, id: genId() };
    chat.messages.push(userMsg);

    // Auto-name chat from first message
    if (chat.messages.length === 1) {
      chat.name = text.slice(0, 40) + (text.length > 40 ? 'â€¦' : '');
      document.getElementById('chat-name-display').textContent = chat.name;
    }

    saveState();
    renderSidebar();

    // Clear input
    input.value = '';
    input.style.height = 'auto';

    // Append user msg to DOM
    appendMessageEl(userMsg, false);

    // Prepare AI message placeholder
    var aiMsg = { role: 'assistant', content: '', id: genId() };
    appendMessageEl(aiMsg, true); // streaming=true â†’ shows cursor

    // Call API
    callAPI(chat.messages.slice(), function(chunk) {
      // onChunk
      aiMsg.content += chunk;
      updateStreamingBubble(aiMsg.content, false);
    }, function() {
      // onDone
      updateStreamingBubble(aiMsg.content, true);
      chat.messages.push(aiMsg);
      saveState();
      setStreaming(false);
    }, function(err) {
      // onError
      updateStreamingBubble('', true);
      var bubble = document.querySelector('[data-msg-id="' + aiMsg.id + '"] .msg-bubble.ai');
      var errEl = document.getElementById('messages');
      // Replace streaming bubble with error
      var streamBubble = document.getElementById('streaming-bubble');
      if (streamBubble) {
        streamBubble.removeAttribute('id');
        streamBubble.innerHTML = '<div class="error-bubble">âš ï¸ ' + esc(err || 'Request failed. Check your API key and try again.') + '</div>';
      }
      setStreaming(false);
    });
  };

  function setStreaming(val) {
    state.isStreaming = val;
    var sendBtn = document.getElementById('send-btn');
    var stopBtn = document.getElementById('stop-btn');
    sendBtn.disabled = val;
    if (val) {
      stopBtn.classList.add('visible');
    } else {
      stopBtn.classList.remove('visible');
      state.abortController = null;
    }
  }

  window.stopGeneration = function() {
    if (state.abortController) {
      state.abortController.abort();
    }
    setStreaming(false);
    // Finalize whatever was streamed
    var streamBubble = document.getElementById('streaming-bubble');
    if (streamBubble) {
      streamBubble.removeAttribute('id');
      // Keep existing content, just remove cursor
      var cursor = streamBubble.querySelector('.typing-cursor');
      if (cursor) cursor.remove();
    }
  };

  // â”€â”€ API Call (Streaming) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function callAPI(messages, onChunk, onDone, onError) {
    setStreaming(true);
    state.abortController = new AbortController();

    // Build payload
    var payload = {
      model: state.settings.model || 'liquid/lfm-2.5-1.2b-thinking:free',
      max_tokens: state.settings.maxTokens || 4096,
      temperature: state.settings.temperature !== undefined ? state.settings.temperature : 0.7,
      stream: true,
      messages: []
    };

    // System prompt
    var sys = (state.settings.systemPrompt || '').trim();
    if (sys) {
      payload.messages.push({ role: 'system', content: sys });
    }

    // Conversation history
    messages.forEach(function(m) {
      if (m.role === 'user' || m.role === 'assistant') {
        payload.messages.push({ role: m.role, content: m.content });
      }
    });

    fetch('https://openrouter.ai/api/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + state.settings.apiKey,
        'Content-Type': 'application/json',
        'HTTP-Referer': window.location.href,
        'X-Title': 'Universal AI Chat'
      },
      body: JSON.stringify(payload),
      signal: state.abortController.signal
    }).then(function(resp) {
      if (!resp.ok) {
        return resp.text().then(function(t) {
          var msg = 'API Error ' + resp.status;
          try {
            var j = JSON.parse(t);
            if (j && j.error && j.error.message) msg = j.error.message;
          } catch(e) {}
          throw new Error(msg);
        });
      }
      if (!resp.body) {
        // Fallback: non-streaming
        return resp.json().then(function(data) {
          var content = '';
          try { content = data.choices[0].message.content; } catch(e) {}
          onChunk(content);
          onDone();
        });
      }

      var reader = resp.body.getReader();
      var decoder = new TextDecoder('utf-8');
      var buffer = '';

      function read() {
        reader.read().then(function(result) {
          if (result.done) { onDone(); return; }

          buffer += decoder.decode(result.value, { stream: true });

          var lines = buffer.split('\n');
          buffer = lines.pop(); // keep incomplete line

          lines.forEach(function(line) {
            line = line.trim();
            if (!line || line === 'data: [DONE]') return;
            if (line.startsWith('data: ')) {
              var jsonStr = line.slice(6);
              try {
                var parsed = JSON.parse(jsonStr);
                var delta = parsed.choices &&
                            parsed.choices[0] &&
                            parsed.choices[0].delta &&
                            parsed.choices[0].delta.content;
                if (delta) onChunk(delta);

                // Check for finish
                var finishReason = parsed.choices &&
                                   parsed.choices[0] &&
                                   parsed.choices[0].finish_reason;
                if (finishReason && finishReason !== 'null') {
                  // Will be caught by done
                }
              } catch(e) { /* skip malformed chunks */ }
            }
          });

          read();
        }).catch(function(err) {
          if (err.name === 'AbortError') { onDone(); return; }
          onError(err.message || 'Stream read error');
        });
      }

      read();

    }).catch(function(err) {
      if (err.name === 'AbortError') { onDone(); return; }
      onError(err.message || 'Network error. Check your connection.');
    });
  }

  // â”€â”€ Keyboard shortcut â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.addEventListener('keydown', function(e) {
    if ((e.ctrlKey || e.metaKey) && e.key === ',') {
      e.preventDefault();
      openSettings();
    }
    if (e.key === 'Escape') {
      closeModal('settings-modal');
      closeModal('sysprompt-modal');
      closeModal('rename-modal');
      closeSidebar();
    }
  });

  // â”€â”€ Enter to confirm rename â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('rename-input').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') confirmRename();
  });

  // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function init() {
    loadState();
    applyDark();

    // Model display
    document.getElementById('model-display').textContent = state.settings.model || 'liquid/lfm-2.5-1.2b-thinking:free';

    // Ensure we have a chat
    if (!state.currentChatId || !state.chats[state.currentChatId]) {
      var id = createChat();
      state.currentChatId = id;
      saveState();
    }

    document.getElementById('chat-name-display').textContent =
      (state.chats[state.currentChatId] && state.chats[state.currentChatId].name) || 'New Chat';

    renderSidebar();
    renderMessages();

    // Prompt for API key if missing
    if (!state.settings.apiKey) {
      setTimeout(function() {
        openSettings();
      }, 600);
    }

    // Hide loader
    var loader = document.getElementById('loading');
    loader.classList.add('hidden');
    setTimeout(function() { loader.style.display = 'none'; }, 350);

    // Focus input
    document.getElementById('user-input').focus();
  }

  // Wait for DOM + CDNs to be ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

})();
</script>
</body>
</html>
